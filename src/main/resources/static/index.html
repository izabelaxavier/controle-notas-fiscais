<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Controle de Notas Fiscais</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/148/148767.png" />

  <style>
    :root {
      --azul-principal: #0018a3;
      --verde-claro: #e8f5e9;
      --azul-acao: #1565c0;
      --cinza-fundo: #f4f6f8;
      --cinza-texto: #333;


      --status-recebida: #009688;
      --status-aguardando: #f9a825;
      --status-posse: #0288d1;
      --status-erro: #c62828;
      --status-conferida: #2e7d32;
      --status-contabilidade: #6a1b9a;
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--cinza-fundo);
      padding: 20px;
      color: var(--cinza-texto);
    }


    .header-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;


      background-color: #e3f2fd;
      padding: 15px 25px;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);

      max-width: 900px;
      margin: 0 auto 30px auto;
    }

    .header-logo {
      height: 60px;
      width: auto;
    }

    h1 {
      margin: 0;
      color: var(--azul-principal);
      font-size: 28px;
    }



    .dashboard {
      display: flex;
      gap: 20px;
      max-width: 900px;
      margin: 0 auto 30px auto;
      justify-content: space-between;
    }

    .clickable-card {
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .clickable-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0,0,0,0.2);
    }

    .card {
      flex: 1;
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      border-bottom: 5px solid #ccc;
    }

    .card h3 { margin: 0; font-size: 14px; color: #666; text-transform: uppercase; }
    .card p { margin: 10px 0 0 0; font-size: 32px; font-weight: bold; color: #333; }

    .card-ti { border-color: var(--status-recebida); }
    .card-secretaria { border-color: var(--status-posse); }
    .card-finalizadas { border-color: var(--status-conferida); }


    form, .filtros, .historico {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      max-width: 900px;
      margin: 0 auto 20px auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    label { display: block; margin-top: 10px; font-weight: bold; }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      margin-top: 18px;
      padding: 12px;
      width: 100%;
      background: var(--azul-principal);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      margin-bottom: 30px;
      border-radius: 10px;
      overflow: hidden;
    }

    th {
      background: var(--azul-principal);
      color: #fff;
      padding: 10px;
      font-size: 14px;
    }

    td {
      padding: 8px;
      border-bottom: 1px solid #eee;
      text-align: center;
      font-size: 13px;
    }

    tr:nth-child(even) { background: var(--verde-claro); }

    .acoes button {
      width: auto;
      padding: 6px 10px;
      margin: 2px;
      background: var(--azul-acao);
      border-radius: 6px;
      font-size: 12px;
    }

    .status {
      color: #fff;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: bold;
      font-size: 12px;
      display: inline-block;
    }

    .status-recebida { background: var(--status-recebida); }
    .status-aguardando { background: var(--status-aguardando); }
    .status-posse { background: var(--status-posse); }
    .status-erro { background: var(--status-erro); }
    .status-conferida { background: var(--status-conferida); }
    .status-contabilidade { background: var(--status-contabilidade); }

    .log {
      font-size: 13px;
      border-left: 4px solid var(--azul-principal);
      background: var(--verde-claro);
      padding: 8px;
      margin-bottom: 6px;
      border-radius: 4px;
    }
  </style>
</head>
<body>

<div class="header-container">
  <img src="/brasao.png" alt="Bras√£o Prefeitura" class="header-logo" onerror="this.style.display='none'">
  <h1>Controle de Notas Fiscais - TI</h1>
</div>

<div class="dashboard">
  <div class="card card-ti clickable-card" onclick="filtrarPorAtalho('Recebida pelo TI')" title="Clique para ver notas no TI">
    <h3>üìç No Setor TI</h3>
    <p id="dashTI">0</p>
  </div>

  <div class="card card-secretaria clickable-card" onclick="filtrarPorAtalho('Em posse da secretaria')" title="Clique para ver notas nas Secretarias">
    <h3>‚è≥ Com Secretarias</h3>
    <p id="dashSecretaria" style="color: #0288d1;">0</p>
  </div>

  <div class="card card-finalizadas clickable-card" onclick="filtrarPorAtalho('Conferida')" title="Clique para ver notas Finalizadas">
    <h3>‚úÖ Finalizadas</h3>
    <p id="dashConcluidas" style="color: #2e7d32;">0</p>
  </div>
</div>

<div class="filtros">
  <button onclick="exportarExcel()" style="background-color: #1d6f42; margin-top: 0; margin-bottom: 15px;">üìä Baixar Relat√≥rio (Excel)</button>

  <label>Filtrar por status</label>
  <select id="filtroStatus">
    <option value="">Todos</option>
    <option value="Recebida pelo TI">üìç Recebida pelo TI (Entrada)</option>
    <option value="Aguardando NAF parcial">Aguardando NAF parcial</option>
    <option value="Em posse da secretaria">Em posse da secretaria</option>
    <option value="Retornou com erro">Retornou com erro</option>
    <option value="Conferida">Conferida</option>
    <option value="Enviada para tesouraria">Enviada para tesouraria</option>
  </select>

  <label>Pesquisar por n√∫mero da NF</label>
  <input type="text" id="buscaNF" placeholder="Digite o n√∫mero da NF" />
</div>

<form id="formNF">
  <input type="hidden" id="indiceEdicao" />

  <label>N√∫mero da NF</label>
  <input type="text" id="numeroNF" required />

  <label style="color: var(--azul-principal);">üìÖ Data de Chegada (TI)</label>
  <input type="date" id="dataChegada" required />

  <label>Respons√°vel do Setor (quem envia)</label>
  <input type="text" id="responsavelSetor" required />

  <label>Secretaria de Destino</label>
  <input type="text" id="secretaria" required />

  <label>Respons√°vel na Secretaria (quem recebe)</label>
  <input type="text" id="responsavelSecretaria" placeholder="Preencher somente na entrega" />

  <label>Valor da NF (opcional)</label>
  <input type="number" id="valor" step="0.01" />

  <label>N√∫mero da NAF Global (opcional)</label>
  <input type="text" id="nafGlobal" />

  <label>Status</label>
  <select id="statusNF">
    <option value="Recebida pelo TI">üìç Recebida pelo TI (Entrada)</option>
    <option value="Aguardando NAF parcial">Aguardando NAF parcial</option>
    <option value="Em posse da secretaria">Em posse da secretaria</option>
    <option value="Retornou com erro">Retornou com erro</option>
    <option value="Conferida">Conferida</option>
    <option value="Enviada para tesouraria">Enviada para tesouraria</option>
  </select>

  <label>Observa√ß√µes</label>
  <textarea id="observacoes"></textarea>

  <button type="submit">Salvar Nota</button>
</form>

<table>
  <thead>
  <tr>
    <th>NF</th>
    <th>Chegada TI</th>
    <th>Resp. Setor</th>
    <th>Secretaria</th>
    <th>Resp. Secretaria</th>
    <th>Valor</th>
    <th>NAF Global</th>
    <th>Status</th>
    <th>A√ß√µes</th>
  </tr>
  </thead>
  <tbody id="listaNotas"></tbody>
</table>

<div class="historico">
  <h2>Hist√≥rico da Nota</h2>
  <div id="historicoLogs">Selecione uma nota para ver o hist√≥rico.</div>
</div>

<footer style="text-align: center; margin-top: 50px; padding: 20px; color: #888; font-size: 12px; border-top: 1px solid #ddd;">
  <p>Controle Interno - Setor de Tecnologia da Informa√ß√£o</p>
  <p>Desenvolvido por: <b>Izabela Xavier</b></p>
</footer>

<script>
  // Vari√°veis e Configura√ß√µes
  const form = document.getElementById('formNF');
  const listaNotas = document.getElementById('listaNotas');
  const indiceEdicao = document.getElementById('indiceEdicao');
  const historicoLogs = document.getElementById('historicoLogs');
  const filtroStatus = document.getElementById('filtroStatus');
  const buscaNF = document.getElementById('buscaNF');
  const dashTI = document.getElementById('dashTI');
  const dashSecretaria = document.getElementById('dashSecretaria');
  const dashConcluidas = document.getElementById('dashConcluidas');

  const numeroNF = document.getElementById('numeroNF');
  const dataChegada = document.getElementById('dataChegada');
  const responsavelSetor = document.getElementById('responsavelSetor');
  const secretaria = document.getElementById('secretaria');
  const responsavelSecretaria = document.getElementById('responsavelSecretaria');
  const valor = document.getElementById('valor');
  const nafGlobal = document.getElementById('nafGlobal');
  const statusNF = document.getElementById('statusNF');
  const observacoes = document.getElementById('observacoes');

  const API_URL = '/notas';
  let notasCache = [];

  async function carregarNotas() {
    try {
      const response = await fetch(API_URL);
      notasCache = await response.json();
      renderizarNotas();
      atualizarDashboard();
    } catch (error) {
      console.error("Erro ao buscar notas:", error);
      listaNotas.innerHTML = '<tr><td colspan="9">Erro ao conectar com o servidor.</td></tr>';
    }
  }

  async function salvarNoBanco(nota, id = null) {
    const metodo = id ? 'PUT' : 'POST';
    const url = id ? `${API_URL}/${id}` : API_URL;

    await fetch(url, {
      method: metodo,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(nota)
    });
    carregarNotas();
  }

  async function excluirDoBanco(id) {
    if (!confirm('Tem certeza que deseja excluir esta nota?')) return;
    await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
    carregarNotas();
  }

  function formatarDataSimples(dataString) {
    if(!dataString) return '-';
    const data = new Date(dataString);
    return data.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
  }

  function getClassStatus(status) {
    if (status === 'Recebida pelo TI') return 'status-recebida';
    if (status === 'Aguardando NAF parcial') return 'status-aguardando';
    if (status === 'Em posse da secretaria') return 'status-posse';
    if (status === 'Retornou com erro') return 'status-erro';
    if (status === 'Conferida') return 'status-conferida';
    if (status === 'Enviada para tesouraria') return 'status-contabilidade';
    return 'status-recebida';
  }

  function atualizarDashboard() {
    const qtdTI = notasCache.filter(n => n.status === 'Recebida pelo TI').length;
    const qtdSecretaria = notasCache.filter(n => n.status === 'Em posse da secretaria').length;
    const qtdConcluidas = notasCache.filter(n =>
            n.status === 'Conferida' || n.status === 'Enviada para tesouraria'
    ).length;

    dashTI.innerText = qtdTI;
    dashSecretaria.innerText = qtdSecretaria;
    dashConcluidas.innerText = qtdConcluidas;
  }

  function filtrarPorAtalho(statusParaFiltrar) {
    filtroStatus.value = statusParaFiltrar;
    filtroStatus.dispatchEvent(new Event('change'));
  }

  function exportarExcel() {
    let csvContent = "data:text/csv;charset=utf-8,NF;Chegada;Setor;Secretaria;Resp. Secretaria;Valor;Status;Observacoes\n";
    notasCache.forEach(nota => {
      const n = nota.numeroNF || "";
      const c = nota.dataChegada || "";
      const s = nota.responsavelSetor || "";
      const sec = nota.secretaria || "";
      const r = nota.responsavelSecretaria || "";
      const v = nota.valor || "";
      const st = nota.status || "";
      const obs = (nota.observacoes || "").replace(/(\r\n|\n|\r)/gm, " ");
      let row = `${n};${c};${s};${sec};${r};${v};${st};${obs}`;
      csvContent += row + "\n";
    });
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "relatorio_notas.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function renderizarNotas() {
    listaNotas.innerHTML = '';
    const statusSelecionado = filtroStatus.value;
    const textoBusca = buscaNF.value.toLowerCase();

    notasCache
            .filter(nota => {
              if (statusSelecionado === 'Conferida') {
                const ehFinalizada = nota.status === 'Conferida' || nota.status === 'Enviada para tesouraria';
                const passaBusca = !textoBusca || nota.numeroNF.toLowerCase().includes(textoBusca);
                return ehFinalizada && passaBusca;
              }
              return (!statusSelecionado || nota.status === statusSelecionado) &&
                      (!textoBusca || nota.numeroNF.toLowerCase().includes(textoBusca));
            })
            .forEach(nota => {
              const tr = document.createElement('tr');
              tr.style.cursor = 'pointer';
              tr.title = "Clique para ver o hist√≥rico e observa√ß√µes";
              tr.onclick = () => exibirHistorico(nota);

              tr.innerHTML = `
          <td>${nota.numeroNF}</td>
          <td>${formatarDataSimples(nota.dataChegada)}</td>
          <td>${nota.responsavelSetor || '-'}</td>
          <td>${nota.secretaria || '-'}</td>
          <td>${nota.responsavelSecretaria || '-'}</td>
          <td>${nota.valor ? parseFloat(nota.valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '-'}</td>
          <td>${nota.nafGlobal || '-'}</td>
          <td>
            <span class="status ${getClassStatus(nota.status)}">${nota.status || 'Recebida pelo TI'}</span>
          </td>
          <td class="acoes">
            <button onclick="event.stopPropagation(); prepararEdicao(${nota.id})">Editar</button>
            <button onclick="event.stopPropagation(); excluirDoBanco(${nota.id})" style="background:#c62828;">Excluir</button>
          </td>
        `;
              listaNotas.appendChild(tr);
            });
  }

  function prepararEdicao(id) {
    const nota = notasCache.find(n => n.id === id);
    if (!nota) return;
    numeroNF.value = nota.numeroNF;
    dataChegada.value = nota.dataChegada;
    responsavelSetor.value = nota.responsavelSetor;
    secretaria.value = nota.secretaria;
    responsavelSecretaria.value = nota.responsavelSecretaria;
    valor.value = nota.valor;
    nafGlobal.value = nota.nafGlobal || '';
    statusNF.value = nota.status;
    observacoes.value = nota.observacoes;
    indiceEdicao.value = id;
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    if (statusNF.value === "Em posse da secretaria" && !responsavelSecretaria.value.trim()) {
      alert("‚ö†Ô∏è ATEN√á√ÉO:\n\nPara definir o status como 'Em posse da secretaria', voc√™ precisa informar o nome do Respons√°vel que recebeu a nota!");
      responsavelSecretaria.focus();
      return;
    }
    const usuario = prompt("Para salvar, digite seu nome (para o hist√≥rico):");
    if (!usuario) {
      alert("√â obrigat√≥rio informar o nome para registrar no hist√≥rico!");
      return;
    }
    const dataHora = new Date().toLocaleString('pt-BR');
    const novaLinhaLog = `<p style="margin: 5px 0; border-bottom: 1px dashed #eee;">
        <strong>[${dataHora}]</strong> üë§ <b>${usuario.toUpperCase()}</b>: <br>
        Status: <strong>${statusNF.value}</strong> <br>
        Obs: ${observacoes.value || 'Sem obs'}
    </p>`;

    const idEdicao = indiceEdicao.value;
    let historicoAntigo = "";
    if (idEdicao) {
      const notaOriginal = notasCache.find(n => n.id == idEdicao);
      if (notaOriginal && notaOriginal.historicoLog) {
        historicoAntigo = notaOriginal.historicoLog;
      }
    }

    const nota = {
      numeroNF: numeroNF.value,
      dataChegada: dataChegada.value,
      responsavelSetor: responsavelSetor.value,
      secretaria: secretaria.value,
      responsavelSecretaria: responsavelSecretaria.value,
      valor: valor.value,
      nafGlobal: nafGlobal.value,
      status: statusNF.value,
      observacoes: observacoes.value,
      historicoLog: novaLinhaLog + historicoAntigo
    };

    await salvarNoBanco(nota, idEdicao || null);
    form.reset();
    indiceEdicao.value = '';
    statusNF.value = "Recebida pelo TI";
  });

  filtroStatus.addEventListener('change', renderizarNotas);
  buscaNF.addEventListener('input', renderizarNotas);
  carregarNotas();

  function exibirHistorico(nota) {
    const logCompleto = nota.historicoLog ? nota.historicoLog : '<p style="color: #666; font-style: italic;">Nenhum registro de altera√ß√£o detalhado ainda.</p>';
    const chegadaFmt = nota.dataChegada ? new Date(nota.dataChegada).toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : 'N√£o informado';
    const cadastroFmt = new Date(nota.dataCadastro || Date.now()).toLocaleDateString('pt-BR');

    historicoLogs.innerHTML = `
      <div class="log">
        <div style="font-size: 1.1em; margin-bottom: 5px; color: #0018a3;">
            <strong>Nota Fiscal n¬∫ ${nota.numeroNF}</strong>
        </div>
        <div style="margin-bottom: 10px; font-size: 0.9em; color: #555;">
            <strong>Chegou no TI:</strong> ${chegadaFmt} <br>
            <strong>Lan√ßada no sistema:</strong> ${cadastroFmt} <br>
            <strong>Status Atual:</strong> <span class="status ${getClassStatus(nota.status)}">${nota.status}</span>
        </div>
        <hr style="margin: 10px 0; border: 0; border-top: 1px solid #ccc;">
        <strong>üìú Linha do Tempo (Quem fez o qu√™):</strong> <br>
        <div style="background: #fdfdfd; padding: 10px; border-radius: 5px; margin-top: 5px; border: 1px solid #ddd; max-height: 250px; overflow-y: auto;">
            ${logCompleto}
        </div>
      </div>
    `;
    historicoLogs.scrollIntoView({ behavior: 'smooth' });
  }
</script>
</body>
</html>